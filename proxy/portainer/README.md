# Portainer - Container Management Platform

This directory contains the standalone Portainer deployment for Docker container management.

## 📋 Overview

Portainer provides a web-based interface for managing Docker containers, images, networks, and volumes. This deployment is configured to work with the proxy network for integration with Nginx Proxy Manager.

## 🚀 Quick Start

### Prerequisites

1. **Docker and Docker Compose installed**
2. **Proxy network created**:
   ```bash
   docker network create proxy
   ```

### Deploy Portainer

1. **Generate admin password**:
   ```bash
   ./setup-portainer.sh
   ```

2. **Or deploy manually**:
   ```bash
   # Generate password file
   echo "your-secure-password" | docker run --rm -i portainer/helper-reset-password > portainer_password
   
   # Deploy
   docker compose up -d
   ```

3. **Access Portainer**:
   - URL: http://YOUR_SERVER_IP:9000
   - Username: `admin`
   - Password: Check `admin_password.txt` or the one you set

## 📁 Structure

```
proxy/portainer/
├── docker-compose.yml          # Portainer service definition  
├── README.md                   # This file
├── setup-portainer.sh          # Setup script (copied from main portainer/)
├── data/                       # Portainer data (created on first run)
├── admin_password.txt          # Plain text password (created by setup)
├── portainer_password          # Hashed password file (created by setup)
└── management scripts/         # Start, stop, restart scripts (created by setup)
```

## 🔧 Configuration

### Access
- **Port**: 9000 (exposed for initial setup, can be proxied later)
- **Network**: proxy (for NPM integration)

### Volumes
- `./data:/data` - Persistent Portainer data
- `./portainer_password:/data/portainer_password:ro` - Admin password file
- `/var/run/docker.sock:/var/run/docker.sock:ro` - Docker socket access

## 🎛️ Management Commands

### Using Setup Script
```bash
# Initial setup
./setup-portainer.sh

# Management commands (created by setup script)
./start.sh      # Start Portainer
./stop.sh       # Stop Portainer  
./restart.sh    # Restart Portainer
./logs.sh       # View logs
```

### Using Docker Compose
```bash
# Start Portainer
docker compose up -d

# Stop Portainer
docker compose down

# View logs
docker compose logs -f portainer

# Update Portainer
docker compose pull
docker compose up -d
```

## 📊 Using Portainer

### First Login
1. **Access web interface**: http://YOUR_SERVER_IP:9000
2. **Login with admin credentials** (check `admin_password.txt`)
3. **Change password immediately** in User settings

### Deploying Stacks

1. **Go to Stacks → Add Stack**
2. **Name your stack** (e.g., "nginx-proxy-manager")
3. **Choose deployment method**:
   - **Upload**: Upload docker-compose.yml file
   - **Repository**: Connect to Git repository
   - **Editor**: Paste compose file content

### Managing the Proxy Network

The proxy network should be visible in:
- **Networks section** of Portainer
- **Available for stack deployments**
- **Accessible by containers** for service discovery

### Deploying Application Stacks

When deploying stacks through Portainer:

1. **Ensure stack uses proxy network**:
   ```yaml
   networks:
     proxy:
       external: true
   ```

2. **Remove port exposures** (services will be accessed via NPM)
3. **Use appropriate service names** for NPM routing

## 🔗 Integration with Nginx Proxy Manager

### Setup NPM Proxy for Portainer

1. **Deploy NPM first** using its docker-compose.yml
2. **Access NPM web interface** (port 81)
3. **Create proxy host for Portainer**:
   - **Domain**: portainer.yourdomain.com
   - **Forward Hostname**: `portainer`
   - **Forward Port**: `9000`
   - **Enable SSL** with Let's Encrypt

### After NPM Setup
Once NPM is configured, you can:
- **Remove port 9000 exposure** from Portainer compose file
- **Access Portainer via domain** through NPM
- **Use internal container communication** only

## 📝 Common Tasks

### Deploy Nginx Proxy Manager
1. **Go to Stacks → Add Stack**
2. **Name**: nginx-proxy-manager
3. **Upload**: `proxy/nginx-proxy-manager/docker-compose.yml`
4. **Deploy stack**

### Deploy AI Stack
1. **Go to Stacks → Add Stack**
2. **Name**: ai-services
3. **Upload**: `stacks/ai/docker-compose.yml`
4. **Deploy stack**

### Manage Containers
- **Start/stop containers** in Containers section
- **View logs** by clicking on container names
- **Execute commands** using console feature
- **Monitor resources** in container details

### Network Management
- **View proxy network** in Networks section
- **See connected containers** 
- **Troubleshoot connectivity** issues

## 🔐 Security

### Default Setup
- **Secure password** generated by setup script
- **Admin-only access** initially
- **Docker socket access** (required for management)

### Production Hardening
1. **Change default password**
2. **Create additional users** with limited permissions
3. **Use proxy access only** (remove direct port exposure)
4. **Enable SSL** through NPM
5. **Regular updates**
6. **Monitor access logs**

### User Management
- **Go to Users** in Portainer
- **Create users** with appropriate roles:
  - **Administrator**: Full access
  - **User**: Limited access to assigned resources
  - **Read-only**: View-only access

## 🔍 Troubleshooting

### Portainer Won't Start
```bash
# Check logs
docker compose logs portainer

# Check Docker socket permissions
ls -la /var/run/docker.sock

# Ensure proxy network exists
docker network ls | grep proxy
```

### Can't Access Web Interface
```bash
# Check if container is running
docker ps | grep portainer

# Test port access
curl -f http://localhost:9000

# Check firewall rules
sudo ufw status
```

### Password Issues
```bash
# Reset password
echo "new-password" | docker run --rm -i portainer/helper-reset-password > portainer_password

# Restart Portainer
docker compose restart portainer
```

### Stack Deployment Issues
1. **Check compose file syntax**
2. **Verify network existence**: `docker network ls`
3. **Ensure image availability**
4. **Check resource constraints**
5. **Review deployment logs** in Portainer

## 📈 Monitoring

### Container Health
- **Container status** in Containers view
- **Resource usage** graphs
- **Log monitoring** through web interface

### System Resources
- **Dashboard overview** of Docker host
- **Image usage** and cleanup options
- **Volume management** and usage

## 🔄 Maintenance

### Regular Tasks
1. **Update Portainer image** regularly
2. **Clean up unused images/containers**
3. **Monitor disk usage**
4. **Backup Portainer data**
5. **Review user access** periodically

### Backup Portainer Data
```bash
# Create backup
sudo tar -czf portainer-backup-$(date +%Y%m%d).tar.gz data/

# Restore backup  
sudo tar -xzf portainer-backup-YYYYMMDD.tar.gz
```

This Portainer instance serves as the central management interface for your entire containerized infrastructure.